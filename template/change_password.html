{% load static %}
<!DOCTYPE html>
<html>
<head>
    <style>
        /* Global styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Form container styles */
        .form-container {
            max-width: 400px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 20px;
        }

        /* Title styles */
        h2 {
            text-align: center;
        }

        /* Label and input styles */
        label {
            display: block;
            margin-top: 10px;
        }

        input[type="password"] {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* Button styles */
        button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* Error message styles */
        #password-change-message {
            margin-top: 10px;
            text-align: center;
            color: red;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Change Password</h2>
        <div id="password-change-success" style="color: green;"></div>  <!-- Moved outside the form -->
    
        <form id="password-change-form">
            {% csrf_token %}
            <label for="old_password">Old Password:</label>
            <input type="password" id="old_password" name="old_password">
            <br>
            <label for="new_password">New Password:</label>
            <input type="password" id="new_password" name="new_password" required oninput="validatePassword()">
            <span id="passwordError" style="color: red;"></span>
            <br>
            <label for="confirm_password">Confirm Password:</label>
            <input type="password" id="confirm_password" name="confirm_password">
            <br>
            <button type="button" id="change-password-button" onclick="changePasswordAndLogout()">Change Password</button>
        </form>
    
        <div id="password-change-message"></div>  <!-- Error message remains inside the form -->
    </div>
    

    <script>
        function validatePassword() {
            var passwordInput = document.getElementById("new_password");
            var passwordError = document.getElementById("passwordError");
            var passwordValue = passwordInput.value;
        
            // Define regular expressions for each condition
            var hasUppercase = /[A-Z]/.test(passwordValue);
            var hasLowercase = /[a-z]/.test(passwordValue);
            var hasSpecialChar = /[!@#$%^&*]/.test(passwordValue);
        
            if (passwordValue.length < 8) {
                passwordError.textContent = "Password must be at least 8 characters long";
            } else if (!hasUppercase) {
                passwordError.textContent = "Password must contain at least one uppercase letter";
            } else if (!hasLowercase) {
                passwordError.textContent = "Password must contain at least one lowercase letter";
            } else if (!hasSpecialChar) {
                passwordError.textContent = "Password must contain at least one special character (!@#$%^&*)";
            } else {
                passwordError.textContent = "";
            }
        }
        
        function changePasswordAndLogout() {
            var oldPassword = document.getElementById('old_password').value;
            var newPassword = document.getElementById('new_password').value;
            var confirmPassword = document.getElementById('confirm_password').value;
        
            if (oldPassword === '') {
                document.getElementById('password-change-message').innerHTML = 'Please enter your old password.';
                return;
            }
        
            if (newPassword !== confirmPassword) {
                document.getElementById('password-change-message').innerHTML = 'Passwords do not match.';
                return;
            }
        
            // Make an AJAX request to change the password
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/change_password/');
            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onload = function () {
                if (xhr.status === 200) {
                    // Display the success message
                    document.getElementById('password-change-success').innerHTML = 'Password changed successfully';
        
                    // Hide the error message
                    document.getElementById('password-change-message').innerHTML = '';
        
                    // Perform the logout action via an AJAX request
                    var logoutXHR = new XMLHttpRequest();
                    logoutXHR.open('GET', '/logout/'); // Replace with the actual logout URL
                    logoutXHR.onload = function () {
                        if (logoutXHR.status === 200) {
                            // Redirect to the login page after a successful password change and logout
                            window.location.href = '/signin/';
                        } else {
                            document.getElementById('password-change-message').innerHTML = 'Password change failed.';
                        }
                    };
                    logoutXHR.send();
                } else {
                    // Display the error message
                    document.getElementById('password-change-message').innerHTML = 'Password change failed.';
        
                    // Clear the success message
                    document.getElementById('password-change-success').innerHTML = '';
                }
            };
            var data = 'old_password=' + oldPassword + '&new_password=' + newPassword + '&confirm_password=' + confirmPassword;
            xhr.send(data);
        }
        
        
    </script>
</body>
</html>